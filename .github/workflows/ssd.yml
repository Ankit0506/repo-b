#This Workflow will build the image from SSD repo and deploy using deployment-settings.
name: SPA Input branch Workflow
on:
  workflow_dispatch:
    inputs:
      branch:                       # **NEW INPUT**
        description: 'Branch to build'
        required: true 
      tag:
        description: 'Tag to deploy'
        required: false
      customer:
        description: 'Customer to deploy'
        required: true
        type: choice
        options:
          - sycamore-spa-demo-ps
          - sycamore-spa-staging-spa01-ps

permissions:
  id-token: write
  contents: write

env:
  organization: "sycamore"
  repository: "ssd"
  remote_branch_name: "${{ github.actor }}-${{ github.run_id }}"
  branch_name: "${{ github.ref_name }}"

jobs:
  runtimeInfo: 
    name: Print Runtime Environment details
    runs-on: self-hosted
    steps:
      - name: Show Runtime Env Values
        run: |
          echo "Running Staging Release workflow with the following Env Values:"
          echo ""
          echo "Deploying Branch: ${{ env.branch_name }}"
          echo "organization: ${{ env.organization }}"
          echo "repository: ${{ env.repository }}"
          echo "remote_branch_name: ${{ env.remote_branch_name }}"
          echo "region: ${{ env.region }}"

#Build the image and push to ECR
  build:
    name: Build Docker Images
    runs-on: self-hosted
    environment: staging
    if: ${{ github.event.inputs.tag != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}
      
      - name: Build
        id: build
        env:
          DOCKER_API_VERSION: "1.43"
          GITHUB_TOKEN: ${{ secrets.PRIVATE_REPO_ACCESS_TOKEN }}
          ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
          ECR_USERNAME: ${{ steps.login-ecr.outputs.docker_username_572421346362_dkr_ecr_us_east_2_amazonaws_com }}
          ECR_PASSWORD: ${{ steps.login-ecr.outputs.docker_password_572421346362_dkr_ecr_us_east_2_amazonaws_com }}
          ECR_REPO_ORG: "sycamore"
          ACTIONS_STEP_DEBUG: true
        shell: bash
        run: |
          echo $ECR_REGISTRY

#Deploy the image using Deployment-setting repo
  deploy:
    name: Deploy Target Environment
    needs: [build]
    if: always()
    runs-on: self-hosted
    steps:
      - name: Checkout deployment-settings
        uses: actions/checkout@v4
        with:
          ref: "main"
          repository: "Sycamore/deployment-settings"
          token: ${{ secrets.PRIVATE_REPO_ACCESS_TOKEN }}

      - name: Set tag env variable
        run: echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_ENV

      - name: Export customer input
        run: echo "customer=${{ github.event.inputs.customer }}" >> $GITHUB_ENV
      
      - name: Configure git Remote
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_ACCESS_TOKEN }}
          BRANCH_NAME: ${{ env.remote_branch_name }}
        run: |
          echo $BRANCH_NAME=${{ env.remote_branch_name }}
          echo "[$(date +%Y-%m-%dT%H:%M:%S%z)] configuring git..."
          git config user.email "noreply@sycamoreinformatics.com"
          git config user.name "GitHub Actions"

          BRANCH_EXISTS=$(git ls-remote --heads origin $BRANCH_NAME)
          if [[ -z ${BRANCH_EXISTS} ]]; then
            echo "[$(date +%Y-%m-%dT%H:%M:%S%z)] branch does not exist"
            git checkout -b $BRANCH_NAME
          else
            echo "[$(date +%Y-%m-%dT%H:%M:%S%z)] branch already exists"
            git fetch
            git switch $BRANCH_NAME
          fi

      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip' # caching pip dependencies

      - name: Install pip requirements
        run: pip install -r requirements.txt
      
      - name: Install GH CLI
        uses: dev-hanz-ops/install-gh-cli-action@v0.1.0
        with:
          gh-cli-version: 2.39.2


      - name: Replace Environment file
        run: |
          if [[ "${customer}" == "sycamore-spa-demo-ps" ]]; then
            echo "environment_file_path=deployments/plat-stage/sycamore-spa/envs/${customer}.yaml" >> $GITHUB_ENV
          elif [[ "${customer}" == "sycamore-spa-staging-spa01-ps" ]]; then
            echo "environment_file_path=deployments/plat-stage/sycamore-spa/envs/${customer}.yaml" >> $GITHUB_ENV
          else
            echo "Invalid customer: $customer"
            exit 1
          fi

      - uses: infovista-opensource/setup-yq4@v0.9.3
      - name: Update Environment Configurations with tag and timestamp
        run: |
          echo "Using environment file: $environment_file_path"
          updatedAt=$(date +%Y%m%d%H%M%S)  
          if [[ -n "${{ github.event.inputs.tag }}" ]]; then
            echo "Updating tag to: ${{ github.event.inputs.tag }}"
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
            image=${{ github.event.inputs.tag }} yq -i '.global.image.tag = strenv(image)' $environment_file_path
          else
            echo "No tag provided. Skipping image tag update."
            echo "just updating timestamp"
          fi
          updatedAt=$updatedAt yq -i '.global.deployed_at = strenv(updatedAt)' $environment_file_path
          git diff $environment_file_path

      - name: Create PR in deployment-settings
        env:
            GH_TOKEN: ${{ secrets.PRIVATE_REPO_ACCESS_TOKEN }}
        run: |
          git status
          BRANCH_NAME="${{ env.remote_branch_name }}"
          BRANCH_EXISTS=$(git ls-remote --heads origin $BRANCH_NAME)

